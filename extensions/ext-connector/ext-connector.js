/**
 * @file ext-connector.js
 *
 * @license MIT
 *
 * @copyright 2010 Alexis Deveria
 *
 */
const t="connector",loadExtensionTranslation=async function(e){let s;const c=e.configObj.pref("lang");try{s=await function __variableDynamicImportRuntime0__(t){switch(t){case"./locale/en.js":return Promise.resolve().then((function(){return n}));case"./locale/fr.js":return Promise.resolve().then((function(){return o}));case"./locale/zh-CN.js":return Promise.resolve().then((function(){return r}));default:return new Promise((function(e,n){("function"==typeof queueMicrotask?queueMicrotask:setTimeout)(n.bind(null,new Error("Unknown variable dynamic import: "+t)))}))}}("./locale/".concat(c,".js"))}catch(e){console.warn("Missing translation (".concat(c,") for ").concat(t," - using 'en'")),s=await Promise.resolve().then((function(){return n}))}e.i18next.addResourceBundle(c,t,s.default)};var e={name:t,async init(e){const n=this,{svgCanvas:o}=n,{getElem:r,$id:s,mergeDeep:c}=o,{svgroot:a}=e,i=o.addSVGElementFromJson,l=e.selectorManager;let u,d,g,m,b,p;await loadExtensionTranslation(n);let{svgcontent:f}=e,_=!1,h=[],y=[];const getBBintersect=(t,e,n,o)=>{o&&(o-=0,(n=c({},n)).width+=o,n.height+=o,n.x-=o/2,n.y-=o/2);const r=n.x+n.width/2,s=n.y+n.height/2,a=t-r,i=e-s;let l;return l=Math.abs(i/a)<n.height/n.width?n.width/2/Math.abs(a):i?n.height/2/Math.abs(i):0,{x:r+a*l,y:s+i*l}},getOffset=(t,e)=>{const n=e.getAttribute("marker-"+t),o=5*e.getAttribute("stroke-width");return n?o:0},showPanel=t=>{let e=s("connector_rules");e||(e=document.createElement("style"),e.setAttribute("id","connector_rules"),document.getElementsByTagName("head")[0].appendChild(e)),e.textContent=t?"#tool_clone, #tool_topath, #tool_angle, #xy_panel { display: none !important; }":"",s("connector_panel")&&(s("connector_panel").style.display=t?"block":"none")},setPoint=(t,e,n,o,r)=>{const s=t.points,c=a.createSVGPoint();c.x=n,c.y=o,"end"===e&&(e=s.numberOfItems-1);try{s.replaceItem(c,e)}catch(r){const s=t.getAttribute("points").split(" ");s[e]=n+","+o,t.setAttribute("points",s.join(" "))}if(r){const e=s.getItem(0),n=s.getItem(s.numberOfItems-1);setPoint(t,1,(n.x+e.x)/2,(n.y+e.y)/2)}},findConnectors=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:y;const e=o.getDataStorage(),n=f.querySelectorAll(".se_connector");h=[],Array.prototype.forEach.call(n,(function(n){let r;const c=[];["start","end"].forEach(((t,r)=>{const a="c_"+t;let i=e.get(n,a);null==i?(i=document.getElementById(n.attributes["se:connector"].value.split(" ")[r]),e.put(n,"c_"+t,i.id),e.put(n,t+"_bb",o.getStrokedBBox([i]))):i=s(i),c.push(i)}),n);for(let e=0;e<2;e++){const s=c[e];r=!1;const a=o.getParents(s.parentNode);if(Array.prototype.forEach.call(a,(function(e){t.includes(e)&&(r=!0)})),s&&s.parentNode){if(t.includes(s)||r){const t=o.getStrokedBBox([s]);h.push({elem:s,connector:n,is_start:0===e,start_x:t.x,start_y:t.y})}}else n.remove()}}))},updateConnectors=t=>{const e=o.getDataStorage();if(findConnectors(t),h.length){let t=h.length;for(;t--;){const n=h[t],r=n.connector,{elem:s}=n,c=n.is_start?"start":"end",a=o.getStrokedBBox([s]);a.x=n.start_x,a.y=n.start_y,e.put(r,c+"_bb",a),e.get(r,c+"_off");const i=n.is_start?"end":"start",l=e.get(r,i+"_bb"),u=l.x+l.width/2,d=l.y+l.height/2;let g=getBBintersect(u,d,a,getOffset(c,r));setPoint(r,n.is_start?0:"end",g.x,g.y,!0);const m=getBBintersect(g.x,g.y,e.get(r,i+"_bb"),getOffset(i,r));if(setPoint(r,n.is_start?"end":0,m.x,m.y,!0),navigator.userAgent.includes("AppleWebKit")){const t=r.points,e=t.numberOfItems,n=[];for(let o=0;o<e;o++)g=t.getItem(o),n[o]=g.x+","+g.y;r.setAttribute("points",n.join(" "))}}}};!function(){const t=o.groupSelectedElements;o.groupSelectedElements=function(){o.removeFromSelection(document.querySelectorAll(".se_connector"));for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return t.apply(this,n)};const e=o.moveSelectedElements;o.moveSelectedElements=function(){for(var t=arguments.length,n=new Array(t),o=0;o<t;o++)n[o]=arguments[o];const r=e.apply(this,n);return updateConnectors(),r},p=o.getEditorNS()}();return{name:n.i18next.t("".concat(t,":name")),callback(){const e="".concat(t,":langListTitle"),n='\n        <se-button id="mode_connect" title="'.concat(e,'" src="conn.svg"></se-button>\n        ');o.insertChildAtIndex(s("tools_left"),n,13),s("mode_connect").addEventListener("click",(()=>{this.leftPanel.updateLeftPanel("ext-panning")&&o.setMode("connector")}))},addLangData:e=>({data:[{id:"mode_connect",title:n.i18next.t("".concat(t,":langListTitle"))}]}),mouseDown(t){const e=o.getDataStorage(),r=t.event;u=t.start_x,d=t.start_y;const s=o.getMode(),{curConfig:{initStroke:c}}=n.configObj;if("connector"===s){if(_)return;const t=r.target;if(o.getParents(t.parentNode).includes(f)){const n=o.getClosest(t.parentNode,"foreignObject");m=n||t;const r=o.getStrokedBBox([m]),s=r.x+r.width/2,a=r.y+r.height/2;_=!0,g=i({element:"polyline",attr:{id:o.getNextId(),points:s+","+a+" "+s+","+a+" "+u+","+d,stroke:"#"+c.color,"stroke-width":m.stroke_width&&0!==m.stroke_width?m.stroke_width:c.width,fill:"none",opacity:c.opacity,style:"pointer-events:none"}}),e.put(g,"start_bb",r)}return{started:!0}}"select"===s&&findConnectors()},mouseMove(t){const e=o.getDataStorage(),n=o.getZoom(),r=t.mouse_x/n,s=t.mouse_y/n,c=r-u,a=s-d,i=o.getMode();if("connector"===i&&_){const t=getBBintersect(r,s,e.get(g,"start_bb"),getOffset("start",g));u=t.x,d=t.y,setPoint(g,0,t.x,t.y,!0),setPoint(g,"end",r,s,!0)}else if("select"===i){let t=y.length;for(;t--;){const n=y[t];n&&e.has(n,"c_start")&&(o.removeFromSelection([n]),n.transform.baseVal.clear())}h.length&&((t,e)=>{const n=o.getDataStorage();let r=h.length;for(;r--;){const o=h[r],s=o.connector,c=o.is_start?"start":"end",a=n.get(s,c+"_bb");a.x=o.start_x+t,a.y=o.start_y+e,n.put(s,c+"_bb",a);const i=o.is_start?"end":"start",l=n.get(s,i+"_bb"),u=l.x+l.width/2,d=l.y+l.height/2,g=getBBintersect(u,d,a,getOffset(c,s));setPoint(s,o.is_start?0:"end",g.x,g.y,!0);const m=getBBintersect(g.x,g.y,n.get(s,i+"_bb"),getOffset(i,s));setPoint(s,o.is_start?"end":0,m.x,m.y,!0)}})(c,a)}},mouseUp(t){const e=o.getDataStorage();let n=t.event.target;if("connector"!==o.getMode())return;const r=o.getClosest(n.parentNode,"foreignObject");r&&(n=r);const s=o.getParents(n.parentNode);if(n===m)return _=!0,{keep:!0,element:null,started:_};if(-1===s.indexOf(f))return g&&g.remove(),_=!1,{keep:!1,element:null,started:_};b=n;const c=m?m.id:"",a=b?b.id:"",i=c+" "+a,h=a+" "+c;if(Array.prototype.filter.call(f.querySelectorAll(".se_connector"),(function(t){const e=t.getAttributeNS(p,"connector");return e===i||e===h})).length)return g.remove(),{keep:!1,element:null,started:!1};const y=o.getStrokedBBox([b]),x=getBBintersect(u,d,y,getOffset("start",g));return setPoint(g,"end",x.x,x.y,!0),e.put(g,"c_start",c),e.put(g,"c_end",a),e.put(g,"end_bb",y),p=o.getEditorNS(!0),g.setAttributeNS(p,"se:connector",i),g.setAttribute("class","se_connector"),g.setAttribute("opacity",1),o.addToSelection([g]),o.moveToBottomSelectedElement(),l.requestSelector(g).showGrips(!1),_=!1,{keep:!0,element:g,started:_}},selectedChanged(t){const e=o.getDataStorage();if(!f.querySelectorAll(".se_connector").length)return;"connector"===o.getMode()&&o.setMode("select"),y=t.elems;let n=y.length;for(;n--;){const o=y[n];o&&e.has(o,"c_start")?(l.requestSelector(o).showGrips(!1),t.selectedElement&&!t.multiselected?showPanel(!0):showPanel(!1)):showPanel(!1)}updateConnectors()},elementChanged(t){const e=o.getDataStorage();let n=t.elems[0];if(n){if("svg"===n.tagName&&"svgcontent"===n.id&&(f=n,(()=>{const t=o.getDataStorage();f.querySelectorAll("*").forEach((function(e){const n=e.getAttributeNS(p,"connector");if(n){e.setAttribute("class","se_connector");const s=n.split(" "),c=o.getStrokedBBox([r(s[0])]),a=o.getStrokedBBox([r(s[1])]);t.put(e,"c_start",s[0]),t.put(e,"c_end",s[1]),t.put(e,"start_bb",c),t.put(e,"end_bb",a),o.getEditorNS(!0)}}))})()),n.getAttribute("marker-start")||n.getAttribute("marker-mid")||n.getAttribute("marker-end")){const t=n.getAttribute("marker-start"),r=n.getAttribute("marker-mid"),s=n.getAttribute("marker-end");if(g=n,e.put(n,"start_off",Boolean(t)),e.put(n,"end_off",Boolean(s)),"line"===n.tagName&&r){const t=Number(n.getAttribute("x1")),e=Number(n.getAttribute("x2")),s=Number(n.getAttribute("y1")),c=Number(n.getAttribute("y2")),{id:a}=n,l=i({element:"polyline",attr:{points:t+","+s+(" "+(t+e)/2+","+(s+c)/2+" ")+e+","+c,stroke:n.getAttribute("stroke"),"stroke-width":n.getAttribute("stroke-width"),"marker-mid":r,fill:"none",opacity:n.getAttribute("opacity")||1}});n.insertAdjacentElement("afterend",l),n.remove(),o.clearSelection(),l.id=a,o.addToSelection([l]),n=l}}if("se_connector"===n.getAttribute("class")){const t=r(e.get(n,"c_start"));updateConnectors([t])}else updateConnectors()}},IDsUpdated(t){const e=[];return t.elems.forEach((function(n){"se:connector"in n.attr&&(n.attr["se:connector"]=n.attr["se:connector"].split(" ").map((function(e){return t.changes[e]})).join(" "),/. ./.test(n.attr["se:connector"])||e.push(n.attr.id))})),{remove:e}},toolButtonStateUpdate(t){const e=document.getElementById("mode_connect");t.nostroke&&!0===e.pressed&&n.clickSelect(),e.disabled=t.nostroke}}}},n=Object.freeze({__proto__:null,default:{name:"Connector",langListTitle:"Connect two objects",langList:[{id:"mode_connect",title:"Connect two objects"}],buttons:[{title:"Connect two objects"}]}}),o=Object.freeze({__proto__:null,default:{name:"Connector",langListTitle:"Connecter deux objets",langList:[{id:"mode_connect",title:"Connecter deux objets"}],buttons:[{title:"Connecter deux objets"}]}}),r=Object.freeze({__proto__:null,default:{name:"连接器",langListTitle:"连接两个对象",langList:[{id:"mode_connect",title:"连接两个对象"}],buttons:[{title:"连接两个对象"}]}});export{e as default};
